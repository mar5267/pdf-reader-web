<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>PDF Reader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
    :root{--bg-overlay:rgba(255,255,255,0.88);--highlight:rgba(255,255,0,0.6)}
    html,body{height:100%;margin:0;font-family:"Times New Roman",Times,serif;background-color:#f2f2f2}
    body{display:flex;flex-direction:column;align-items:center;padding:18px;box-sizing:border-box;background-size:cover;background-position:center}
    h1{margin:6px 0 12px;font-family:Georgia,serif}
    .top-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-bottom:10px}
    input[type=file]{display:inline-block}
    #controls{margin:8px 0;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    button{padding:8px 12px;font-size:15px;border-radius:8px;border:1px solid #888;background:#fff;cursor:pointer}
    button:active{transform:translateY(1px)}
    #status{margin:8px 0;font-size:14px;color:#333}
    #text-display{
      width:86%;
      max-width:980px;
      background:var(--bg-overlay);
      padding:20px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      text-align:left;
      font-size:14pt; /* tamaño 14 */
      line-height:4.0; /* espaciado 4.0 */
      max-height:66vh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    #text-display span{transition:background .12s}
    .highlight{background:var(--highlight)}
    .small-note{font-size:13px;color:#444;margin-top:6px;text-align:center}
    .footer{margin-top:12px;font-size:13px;color:#666}
  </style>
</head>
<body>
  <h1>PDF Reader</h1>

  <div class="top-controls">
    <label>
      Subir PDF
      <input id="fileInput" type="file" accept="application/pdf">
    </label>

    <label>
      Cambiar wallpaper
      <input id="wallpaperInput" type="file" accept="image/*">
    </label>
  </div>

  <div id="controls">
    <button id="readBtn">▶️ Leer</button>
    <button id="pauseBtn">⏸️ Pausar</button>
    <button id="resumeBtn">▶️ Reanudar</button>
    <button id="stopBtn">⏹️ Detener</button>
    <button id="prevBtn">⬅️ Página anterior</button>
    <button id="nextBtn">➡️ Página siguiente</button>
  </div>

  <div id="status">Sin PDF cargado</div>

  <div id="text-display">Aquí aparecerá el texto del PDF. Sube un PDF para empezar.</div>

  <div class="small-note">La voz usada es la del navegador (SpeechSynthesis). En móviles iOS puede pedir que pulses 'Leer' para permitir audio.</div>
  <div class="footer">Texto: Times New Roman · Tamaño 14 · Interlineado 4.0</div>

<script>
const fileInput = document.getElementById('fileInput');
const wallpaperInput = document.getElementById('wallpaperInput');
const textDisplay = document.getElementById('text-display');
const status = document.getElementById('status');

const readBtn = document.getElementById('readBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const stopBtn = document.getElementById('stopBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

let pdfDoc = null;
let pageNum = parseInt(localStorage.getItem('pdf_reader_last_page') || '1', 10) || 1;
let sentences = [];
let currentIndex = 0;
let utterance = null;
let isPaused = false;
let isPlaying = false;

// Wallpaper handler
wallpaperInput.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    document.body.style.backgroundImage = `url('${reader.result}')`;
  };
  reader.readAsDataURL(f);
});

// Load PDF
fileInput.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  if (f.type !== 'application/pdf') { alert('Por favor, selecciona un archivo PDF.'); return; }
  const reader = new FileReader();
  reader.onload = function() {
    const typedarray = new Uint8Array(this.result);
    pdfjsLib.getDocument(typedarray).promise.then(pdf => {
      pdfDoc = pdf;
      if (pageNum < 1) pageNum = 1;
      if (pageNum > pdfDoc.numPages) pageNum = 1;
      loadPage(pageNum);
    }).catch(err => {
      console.error(err);
      alert('Error cargando PDF.');
    });
  };
  reader.readAsArrayBuffer(f);
});

function splitIntoSentences(text){
  // Split on ., ?, ! keeping punctuation
  const raw = text.replace(/\s+/g,' ').trim();
  if (!raw) return [];
  const parts = raw.match(/[^.!?]+[.!?]?/g) || [raw];
  return parts.map(s => s.trim()).filter(Boolean);
}

function loadPage(num){
  if (!pdfDoc) return;
  pdfDoc.getPage(num).then(page => {
    return page.getTextContent();
  }).then(textContent => {
    const text = textContent.items.map(i=>i.str).join(' ');
    sentences = splitIntoSentences(text);
    currentIndex = 0;
    renderSentences();
    status.textContent = `Página ${num} de ${pdfDoc.numPages}`;
    localStorage.setItem('pdf_reader_last_page', String(num));
  }).catch(err => {
    console.error(err);
    alert('Error al leer la página del PDF.');
  });
}

function renderSentences(){
  textDisplay.innerHTML = '';
  sentences.forEach((s, idx) => {
    const span = document.createElement('span');
    span.textContent = s + (/[.!?]$/.test(s) ? ' ' : '. ');
    span.dataset.idx = idx;
    textDisplay.appendChild(span);
  });
  // scroll to current
  scrollToSentence(currentIndex);
}

function scrollToSentence(i){
  const el = textDisplay.querySelector(`span[data-idx="${i}"]`);
  if (el) {
    el.scrollIntoView({behavior:'smooth',block:'center'});
  }
}

// Speech controls
function speakCurrent(){
  if (!sentences.length) return;
  if (currentIndex >= sentences.length) { isPlaying=false; return; }
  const text = sentences[currentIndex];
  // remove previous highlight
  Array.from(textDisplay.children).forEach(c=>c.classList.remove('highlight'));
  const el = textDisplay.querySelector(`span[data-idx="${currentIndex}"]`);
  if (el) el.classList.add('highlight');

  utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'es-ES';
  utterance.rate = 1.0;
  utterance.pitch = 1.0;
  utterance.onend = () => {
    // remove highlight of finished sentence
    if (el) el.classList.remove('highlight');
    currentIndex++;
    if (!isPaused) {
      if (currentIndex < sentences.length) {
        speakCurrent();
      } else {
        isPlaying = false;
      }
    }
  };
  utterance.onerror = (e) => {
    console.error('Speech error', e);
    isPlaying = false;
    alert('Error al reproducir audio en el navegador.');
  };
  // Play - browsers require a user gesture (pressing the Read button) to allow audio in some cases
  window.speechSynthesis.speak(utterance);
  isPlaying = true;
}

readBtn.addEventListener('click', () => {
  if (!pdfDoc) { alert('Sube primero un PDF.'); return; }
  if (isPlaying && !isPaused) { alert('Ya se está reproduciendo.'); return; }
  if (isPaused && utterance) {
    // resume
    window.speechSynthesis.resume();
    isPaused = false;
    return;
  }
  // start from currentIndex
  isPaused = false;
  speakCurrent();
});

pauseBtn.addEventListener('click', () => {
  if (!isPlaying) return;
  window.speechSynthesis.pause();
  isPaused = true;
});

resumeBtn.addEventListener('click', () => {
  if (!isPlaying) return;
  window.speechSynthesis.resume();
  isPaused = false;
});

stopBtn.addEventListener('click', () => {
  window.speechSynthesis.cancel();
  isPaused = false;
  isPlaying = false;
  // clear highlights
  Array.from(textDisplay.children).forEach(c=>c.classList.remove('highlight'));
  currentIndex = 0;
});

prevBtn.addEventListener('click', () => {
  if (!pdfDoc) return;
  if (pageNum <= 1) return;
  pageNum--;
  window.speechSynthesis.cancel();
  isPlaying=false; isPaused=false;
  loadPage(pageNum);
});

nextBtn.addEventListener('click', () => {
  if (!pdfDoc) return;
  if (pageNum >= pdfDoc.numPages) return;
  pageNum++;
  window.speechSynthesis.cancel();
  isPlaying=false; isPaused=false;
  loadPage(pageNum);
});

// ensure Safari/iOS user gesture: focus read button on tap
// also prevent accidental long text causing auto-block; split per sentence already
</script>
</body>
</html>
